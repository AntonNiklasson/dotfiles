#!/usr/bin/env zx

import { $ } from 'zx'

// Claude Linear Integration
// Usage:
//   claude-linear <ticket-id>      - Launch Claude with instruction to research the ticket

const TICKET_ID = process.argv[3] || ''

if (!TICKET_ID) {
  console.log('Usage: claude-linear <ticket-id>')
  console.log('Example: claude-linear APP-1931')
  process.exit(1)
}

// $`claude mcp add --transport sse linear https://mcp.linear.app/sse`

console.log(`Researching ticket ${TICKET_ID}...`)

const PROMPT = `You are tasked with researching a linear ticket, analyzing the current state of the codebase and try to come up with a solution to the mentioned bug or feature request from the ticket.

- Linear ticket: ${TICKET_ID}. 

IMPORTANT: The identifier '${TICKET_ID}' is an issue identifier, not the actual id. To get full issue details:
1. First use mcp__linear__list_issues with query='${TICKET_ID}' to find the issue and get its UUID. Limit this query to 1, otherwise the response will be huge.
2. Then use mcp__linear__get_issue with the UUID to get complete details

Once you have the ticket details, make sure you read it carefully. Including comments, screenshots, attached links and documents.

After understanding the ticket:
- If it's a simple, straightforward change (e.g., small bug fix, minor UI tweak, configuration update), go ahead and implement it directly
- If it's complex (e.g., new feature, architectural changes, multiple components affected), first present a plan for discussion including:
  - Overview of the changes needed
  - Testing strategies
  - Feature flagging considerations (if applicable)
  - Simplifications and common patterns from the codebase
  - Any potential risks or concerns
  - Alternative approaches that you deemed not as effective

Use your judgment to decide which approach is appropriate based on the ticket's complexity and scope.`

const flags = [
  'allowedTools="Read,Grep,Glob,Bash(git:*),Bash(pnpm:*),mcp__linear",
]

$.sync`claude ${flags} ${PROMPT}`
